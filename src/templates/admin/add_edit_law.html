{% extends "base.html" %}

{% block title %}{% if law %}Editar Lei{% else %}Adicionar Lei{% endif %} - Admin{% endblock %}

{% block head_extra %}
<style>
    /* Ensure Quill editor has a reasonable height */
    #editor-container {
        height: 300px;
        background-color: white; /* Ensure white background for editor */
        color: black; /* Ensure black text color */
        border: 1px solid #ccc;
        border-radius: 0.25rem;
    }
    .ql-toolbar {
        background-color: #f8f9fa;
        border-top-left-radius: 0.25rem;
        border-top-right-radius: 0.25rem;
        border-bottom: 1px solid #ccc;
    }
    .ql-editor {
        color: black; /* Ensure text inside editor is black */
    }
    .ql-toolbar .ql-stroke {
        stroke: black;
    }
    .ql-toolbar .ql-fill {
        fill: black;
    }
    
    /* Custom HTML paste button */
    .html-paste-container {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }
    
    .html-paste-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
        transition: background-color 0.3s ease;
    }
    
    .html-paste-btn:hover {
        background-color: #218838;
    }
    
    .html-clear-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
        transition: background-color 0.3s ease;
    }
    
    .html-clear-btn:hover {
        background-color: #c82333;
    }
    
    .html-textarea {
        width: 100%;
        height: 100px;
        margin-top: 10px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        background-color: white;
        display: none;
    }
    
    .html-help-text {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
    }

    /* Inputs com foco azul */
    input:focus, select:focus, textarea:focus {
        outline: none;
        box-shadow: 0 0 0 2px #60a5fa;
        border-color: transparent;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6" style="color: #2563eb;">{% if law %}Editar Lei{% else %}Adicionar Nova Lei{% endif %}</h1>

<form method="POST" action="{% if law %}{{ url_for("admin.edit_law", law_id=law.id) }}{% else %}{{ url_for("admin.add_law") }}{% endif %}" id="law-form" class="bg-white shadow-md rounded-lg p-6 border border-gray-200">
    <div class="mb-4">
        <label for="title" class="block text-brand-text text-sm font-bold mb-2">T√≠tulo:</label>
        <input type="text" id="title" name="title" value="{{ law.title if law else "" }}" required class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 text-brand-text leading-tight focus:outline-none focus:border-transparent">
    </div>

    <div class="mb-4">
        <label for="subject_id" class="block text-brand-text text-sm font-bold mb-2">Mat√©ria:</label>
        <select id="subject_id" name="subject_id" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 text-brand-text leading-tight focus:outline-none focus:border-transparent bg-white">
            <option value="None">-- Nenhuma --</option> {# Option for no subject #}
            {% for subject in subjects %}
                <option value="{{ subject.id }}" {% if law and law.subject_id == subject.id %}selected{% endif %}>{{ subject.name }}</option>
            {% endfor %}
        </select>
        <p class="text-xs text-gray-500 mt-1">Voc√™ pode gerenciar as mat√©rias <a href="{{ url_for("admin.manage_subjects") }}" class="hover:underline" style="color: #2563eb;">aqui</a>.</p>
    </div>

    <div class="mb-4">
        <label for="description" class="block text-brand-text text-sm font-bold mb-2">Descri√ß√£o (Opcional):</label>
        <textarea id="description" name="description" rows="3" class="shadow-sm appearance-none border border-gray-300 rounded w-full py-2 px-3 text-brand-text leading-tight focus:outline-none focus:border-transparent">{{ law.description if law else "" }}</textarea>
    </div>

    <div class="mb-6">
        <label for="editor-container" class="block text-brand-text text-sm font-bold mb-2">Conte√∫do:</label>
        
        <!-- HTML Paste Helper -->
        <div class="html-paste-container">
            <button type="button" id="show-html-paste" class="html-paste-btn">üìã Colar HTML Formatado</button>
            <button type="button" id="clear-content" class="html-clear-btn">üóëÔ∏è Limpar Conte√∫do</button>
            <div class="html-help-text">
                üí° Use o bot√£o "Colar HTML Formatado" para inserir conte√∫do com formata√ß√£o avan√ßada (cores, estilos, etc.)
            </div>
            <textarea id="html-paste-area" class="html-textarea" placeholder="Cole seu HTML formatado aqui e clique em 'Aplicar HTML' para inserir no editor..."></textarea>
            <div id="html-paste-actions" style="display: none; margin-top: 10px;">
                <button type="button" id="apply-html" class="html-paste-btn">‚úÖ Aplicar HTML</button>
                <button type="button" id="cancel-html" class="html-clear-btn">‚ùå Cancelar</button>
            </div>
        </div>
        
        <!-- Create the editor container -->
        <div id="editor-container">{{ law.content | safe if law else "" }}</div>
        <!-- Hidden input to store Quill content -->
        <input type="hidden" name="content" id="content-input">
    </div>

    <div class="flex items-center justify-between">
        <button type="submit" class="text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300"
                style="background-color: #2563eb; border: none;"
                onmouseover="this.style.backgroundColor='#1d4ed8'"
                onmouseout="this.style.backgroundColor='#2563eb'">
            {% if law %}Salvar Altera√ß√µes{% else %}Adicionar Lei{% endif %}
        </button>
        <a href="{{ url_for("admin.dashboard") }}" class="inline-block align-baseline font-bold text-sm transition-all duration-300"
           style="color: #1d4ed8;"
           onmouseover="this.style.color='#1e40af'"
           onmouseout="this.style.color='#1d4ed8'">
            Cancelar
        </a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    // Initialize Quill editor with enhanced toolbar
    var quill = new Quill("#editor-container", {
        theme: "snow",
        modules: {
            toolbar: [
                [{ "header": [1, 2, 3, 4, 5, 6, false] }],
                ["bold", "italic", "underline", "strike"],
                [{ "script": "sub"}, { "script": "super" }],
                [{ "list": "ordered"}, { "list": "bullet" }],
                [{ "indent": "-1"}, { "indent": "+1" }],
                [{ "color": [] }, { "background": [] }],
                [{ "font": [] }],
                [{ "align": [] }],
                ["link", "image"],
                ["blockquote", "code-block"],
                ["clean"]
            ]
        },
        formats: ['header', 'bold', 'italic', 'underline', 'strike', 'script', 'list', 'bullet', 'indent', 'color', 'background', 'font', 'align', 'link', 'image', 'blockquote', 'code-block'],
        placeholder: "Digite o conte√∫do da legisla√ß√£o aqui..."
    });

    // Get form elements
    var form = document.getElementById("law-form");
    var contentInput = document.getElementById("content-input");
    var showHtmlPasteBtn = document.getElementById("show-html-paste");
    var clearContentBtn = document.getElementById("clear-content");
    var htmlPasteArea = document.getElementById("html-paste-area");
    var htmlPasteActions = document.getElementById("html-paste-actions");
    var applyHtmlBtn = document.getElementById("apply-html");
    var cancelHtmlBtn = document.getElementById("cancel-html");

    // Show HTML paste area
    showHtmlPasteBtn.addEventListener("click", function() {
        htmlPasteArea.style.display = "block";
        htmlPasteActions.style.display = "block";
        htmlPasteArea.focus();
        htmlPasteArea.placeholder = "Cole seu HTML aqui. Exemplo:\n<h1>T√çTULO I</h1>\n<p><strong>Art. 1¬∫</strong> - Texto do artigo...</p>\n<p style='color: red;'>Texto colorido</p>";
    });

    // Improved HTML application with better formatting preservation
    applyHtmlBtn.addEventListener("click", function() {
        var htmlContent = htmlPasteArea.value.trim();
        if (htmlContent) {
            try {
                // Method 1: Use Quill's clipboard module for better HTML parsing
                var delta = quill.clipboard.convert(htmlContent);
                quill.setContents(delta);
                
                // If that doesn't work well, fallback to direct innerHTML
                setTimeout(function() {
                    if (quill.getText().trim() === '') {
                        console.log('Fallback: usando innerHTML direto');
                        quill.root.innerHTML = htmlContent;
                    }
                }, 100);
                
                htmlPasteArea.value = "";
                htmlPasteArea.style.display = "none";
                htmlPasteActions.style.display = "none";
                
                alert("‚úÖ HTML aplicado com sucesso!\n\nüí° Dicas:\n- Use a barra de ferramentas para ajustar formata√ß√£o\n- Headers (H1, H2, etc.) s√£o preservados\n- Cores e estilos s√£o mantidos");
                
            } catch (error) {
                console.error('Erro ao aplicar HTML:', error);
                // Fallback method
                try {
                    quill.root.innerHTML = htmlContent;
                    alert("‚úÖ HTML aplicado (m√©todo alternativo)!");
                } catch (fallbackError) {
                    console.error('Erro no fallback:', fallbackError);
                    alert("‚ùå Erro ao aplicar HTML. Verifique se o c√≥digo est√° correto.\n\nDica: Use HTML simples como:\n<h1>T√≠tulo</h1>\n<p><strong>Texto negrito</strong></p>");
                }
            }
        } else {
            alert("Por favor, cole o HTML na √°rea de texto primeiro.");
        }
    });

    // Cancel HTML paste
    cancelHtmlBtn.addEventListener("click", function() {
        htmlPasteArea.value = "";
        htmlPasteArea.style.display = "none";
        htmlPasteActions.style.display = "none";
    });

    // Clear all content
    clearContentBtn.addEventListener("click", function() {
        if (confirm("Tem certeza que deseja limpar todo o conte√∫do?")) {
            quill.setText('');
            htmlPasteArea.value = "";
        }
    });

    // Form submission handler
    form.addEventListener("submit", function(event) {
        // Get the HTML content from the Quill editor
        var quillContent = quill.root.innerHTML;
        // Set the value of the hidden input field
        contentInput.value = quillContent;
        
        // Debug log
        console.log('Conte√∫do sendo salvo:', quillContent);
    });

    // Add keyboard shortcut for HTML paste (Ctrl+Shift+V)
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'V') {
            e.preventDefault();
            showHtmlPasteBtn.click();
        }
    });

    // Enhanced paste event handler for better HTML support
    quill.root.addEventListener('paste', function(e) {
        // Let Quill handle the paste naturally, but log for debugging
        setTimeout(function() {
            console.log('Paste detectado, conte√∫do atual:', quill.root.innerHTML);
        }, 100);
    });
</script>
{% endblock %}

