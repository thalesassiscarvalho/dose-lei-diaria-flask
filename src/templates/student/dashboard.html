{% extends "base.html" %}

{% block title %}Meu Painel - Estudo da Lei Seca{% endblock %}

{% block head_extra %}
<style>
    /* ===================================================================== */
    /* <<< IN√çCIO DAS ALTERA√á√ïES DE ESTILO >>> */
    /* ===================================================================== */

    /* Estilos Gerais (sem altera√ß√µes) */
    .law-card { transition: all 0.3s ease; background-color: #FFFFFF; border: 1px solid #dbeafe; color: #374151; display: flex; flex-direction: column; justify-content: space-between; min-height: 170px; border-radius: 0.75rem; box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05); position: relative; }
    .law-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.1), 0 4px 6px -2px rgba(37, 99, 235, 0.05); border-color: #93c5fd; }
    .progress-bar-container { height: 8px; border-radius: 4px; background-color: #e5e7eb; overflow: hidden; flex-grow: 1; }
    .progress-bar-fill { height: 100%; border-radius: 4px; background-color: #2563eb; transition: width 0.5s ease; }
    .completed-badge { background-color: #D1FAE5; color: #065F46; font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 9999px; font-weight: 600; }
    .in-progress-badge { background-color: #DBEAFE; color: #1E40AF; font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 9999px; font-weight: 600; }
    .action-button { background-color: #2563eb; color: white; font-size: 0.875rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; border: none; cursor: pointer; transition: background-color 0.2s ease; text-align: center; display: inline-flex; align-items: center; justify-content: center; }
    .action-button:hover { background-color: #1d4ed8; }
    .achievement-badge { display: inline-flex; align-items: center; background-color: #FEF3C7; color: #92400E; font-size: 0.8rem; padding: 0.3rem 0.7rem; border-radius: 15px; font-weight: 500; border: 1px solid #FDE68A; }
    .achievement-badge i { margin-right: 0.4rem; color: #D97706; }
    .favorite-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; color: #d1d5db; font-size: 1.25rem; transition: color 0.2s ease, transform 0.2s ease; }
    .favorite-btn:hover { transform: scale(1.1); }
    .favorite-btn.favorited { color: #facc15; }
    .favorite-btn i { display: block; }
    .rich-content img { max-width: 100%; height: auto; border-radius: 0.375rem; margin: 0.5rem 0; }
    .rich-content a { color: #2563eb; text-decoration: underline; }
    .rich-content a:hover { color: #1d4ed8; }
    .rich-content ul, .rich-content ol { margin-left: 1.5rem; margin-bottom: 0.5rem; }
    .rich-content blockquote { border-left: 4px solid #e5e7eb; padding-left: 1rem; margin: 0.5rem 0; color: #4b5563; }
    .announcement-container { margin-bottom: 2rem; transition: all 0.3s ease; }

    /* Efeito de eleva√ß√£o adicionado aos cards de aviso */
    .fixed-announcement-box { 
        background-color: #fee2e2; /* Cor de fundo vermelho claro */
        border: 1px solid #fca5a5; /* Borda vermelha mais escura */
        border-left: 4px solid #ef4444; /* Borda esquerda vermelha vibrante */
        color: #991b1b; /* Cor do texto vermelho escuro */
        padding: 1.25rem; 
        border-radius: 0.75rem; 
        margin-bottom: 1.5rem; 
        box-shadow: 0 4px 8px -2px rgba(239, 68, 68, 0.1), 0 2px 4px -2px rgba(239, 68, 68, 0.07); 
        position: relative; 
        overflow: hidden; 
    }
    .announcement-box { background-color: #FEF9C3; border: 1px solid #FDE68A; border-left: 4px solid #F59E0B; color: #92400E; padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1.5rem; box-shadow: 0 4px 8px -2px rgba(245, 158, 11, 0.1), 0 2px 4px -2px rgba(245, 158, 11, 0.07); position: relative; overflow: hidden; transition: all 0.3s ease; }

    .fixed-announcement-box h2 { 
        font-size: 1.1rem; 
        font-weight: 600; 
        margin-bottom: 0.5rem; 
        display: flex; 
        align-items: center; 
        color: #991b1b; /* Cor do t√≠tulo vermelho escuro */
    }
    .fixed-announcement-box h2 i { 
        margin-right: 0.75rem; 
        color: #ef4444; /* Cor do √≠cone vermelho vibrante */
        font-size: 1.25rem; 
    }
    .fixed-announcement-item { padding: 0.75rem 0; border-top: 1px dashed rgba(252, 165, 165, 0.7); transition: all 0.3s ease; } /* Borda tracejada vermelha */
    .fixed-announcement-item:first-child { border-top: none; padding-top: 0; }
    .fixed-announcement-item:last-child { padding-bottom: 0; }
    .announcement-box h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; color: #92400E; }
    .announcement-box h2 i { margin-right: 0.75rem; color: #F59E0B; font-size: 1.25rem; }
    .non-fixed-announcement-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem 0; border-top: 1px dashed rgba(252, 211, 77, 0.7); transition: all 0.3s ease; }
    .non-fixed-announcement-item:first-child { border-top: none; padding-top: 0; }
    .non-fixed-announcement-item:last-child { padding-bottom: 0; }
    .non-fixed-announcement-item .announcement-content { flex-grow: 1; }
    .mark-seen-checkbox-container { position: relative; min-width: 1.5rem; height: 1.5rem; margin-top: 0.2rem; display: block; cursor: pointer; }
    .mark-seen-checkbox { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
    .checkmark { position: absolute; top: 0; left: 0; height: 1.5rem; width: 1.5rem; background-color: #FEF9C3; border: 2px solid #F59E0B; border-radius: 4px; transition: all 0.2s ease; }
    .mark-seen-checkbox:hover ~ .checkmark { background-color: #FDE68A; }
    .mark-seen-checkbox:checked ~ .checkmark { background-color: #F59E0B; border-color: #D97706; }
    .checkmark:after { content: ""; position: absolute; display: none; }
    .mark-seen-checkbox:checked ~ .checkmark:after { display: block; }
    .mark-seen-checkbox-container .checkmark:after { left: 0.45rem; top: 0.2rem; width: 0.35rem; height: 0.7rem; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
    .mark-seen-checkbox-container .tooltip { visibility: hidden; width: 120px; background-color: rgba(0, 0, 0, 0.8); color: #fff; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; }
    .mark-seen-checkbox-container:hover .tooltip { visibility: visible; opacity: 1; }
    @keyframes fadeOut { from { opacity: 1; height: auto; } to { opacity: 0; height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; border-width: 0; } }
    .fade-out { animation: fadeOut 0.5s ease forwards; overflow: hidden; }
    
    .recent-activities-card .stat-card-title {
        margin-bottom: 0.75rem;
    }
    .compact-activity-link {
        display: block;
        padding: 0.65rem 0.85rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease, border-color 0.2s ease;
        border: 1px solid #dbeafe; /* Borda sutil para combinar com o fundo */
        background-color: #ffffff; /* Fundo branco para os links se destacarem */
        text-decoration: none;
    }
    .compact-activity-link:hover {
        background-color: #eff6ff;
        border-color: #bfdbfe;
    }
    .compact-activity-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
    }
    .compact-activity-title {
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: 1rem;
    }
    .compact-activity-time {
        font-size: 0.75rem;
        color: #6b7280;
        flex-shrink: 0;
        white-space: nowrap;
    }

    /* Estilo base para todos os cards, com a nova sombra para eleva√ß√£o */
    .stat-card {
        background-color: #ffffff;
        border: 1px solid #e5e7eb;
        border-left: 4px solid; /* Adiciona a borda esquerda */
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative; /* Necess√°rio para o border-left */
        overflow: hidden; /* Garante que a sombra n√£o vaze */
    }
    /* Efeito de hover aprimorado para todos os cards */
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.08);
        border-color: #93c5fd; /* Manter a cor da borda ao hover para consist√™ncia */
    }

    .stat-card-title { display: flex; align-items: center; font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; }
    .stat-card-title i { margin-right: 0.75rem; font-size: 1.25rem; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; }

    /* Cores e estilos espec√≠ficos para cada tipo de card, seguindo a nova paleta */

    /* Atividades Recentes */
    .recent-activities-card {
        background-color: #f8f8f8; /* Cinza claro */
        border-color: #e0e0e0;
        border-left-color: #9e9e9e; /* Cinza m√©dio */
        box-shadow: 0 4px 8px -2px rgba(158, 158, 158, 0.1), 0 2px 4px -2px rgba(158, 158, 158, 0.07);
    }
    .recent-activities-card .stat-card-title i {
        color: #757575; /* Cinza escuro */
        background-color: #eeeeee;
    }
    .recent-activities-card:hover {
        border-color: #bdbdbd;
        box-shadow: 0 10px 20px -5px rgba(158, 158, 158, 0.15), 0 4px 6px -4px rgba(158, 158, 158, 0.1);
    }

    /* Sequ√™ncia de Estudos */
    .streak-card {
        text-align: center;
        justify-content: center;
        background: linear-gradient(145deg, #fff3e0, #fff9f0); /* Laranja/√¢mbar claro */
        border-color: #ffcc80;
        border-left-color: #ff9800; /* Laranja vibrante */
        box-shadow: 0 4px 8px -2px rgba(255, 152, 0, 0.1), 0 2px 4px -2px rgba(255, 152, 0, 0.07);
    }
    .streak-card .stat-card-title {
        justify-content: center;
    }
    .streak-card .stat-card-title i {
        color: #f57c00; /* Laranja escuro */
        background-color: #fff9e6;
    }
    .streak-display {
        font-size: 2.75rem;
        font-weight: 800;
        color: #ef6c00; /* Laranja ainda mais escuro */
        line-height: 1;
        margin-top: 0.5rem;
    }
    .streak-text {
        font-size: 0.875rem;
        font-weight: 500;
        color: #f97316;
        margin-top: 0.25rem;
    }
    .streak-card:hover {
        border-color: #ffb74d;
        box-shadow: 0 10px 20px -5px rgba(255, 152, 0, 0.15), 0 4px 6px -4px rgba(255, 152, 0, 0.1);
    }

    /* Meu N√≠vel */
    .level-card {
        background: linear-gradient(145deg, #e0f7fa, #f0fcfe); /* Ciano claro */
        border: 1px solid #80deea;
        border-left: 4px solid #00bcd4; /* Ciano vibrante, borda mais grossa */
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 4px 8px -2px rgba(0, 188, 212, 0.1), 0 2px 4px -2px rgba(0, 188, 212, 0.07);
    }
    .level-card .stat-card-title i {
        color: #00838f; /* Ciano escuro */
        background-color: #e0f7fa;
    }
    .level-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    .level-icon {
        font-size: 2rem;
        color: #00838f;
    }
    .level-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: #006064;
    }
    .level-points {
        font-size: 0.875rem;
        font-weight: 500;
        color: #00838f;
        margin-top: -4px;
    }
    .xp-bar-container {
        height: 12px;
        width: 100%;
        background-color: rgba(0, 188, 212, 0.1);
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid rgba(0, 188, 212, 0.2);
    }
    .xp-bar-fill {
        height: 100%;
        background: linear-gradient(to right, #26c6da, #00bcd4);
        border-radius: 6px;
        transition: width 0.5s ease-in-out;
        box-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
    }
    .next-level-info {
        font-size: 0.8rem;
        font-weight: 500;
        color: #00838f;
        text-align: right;
        margin-top: 0.5rem;
    }
    .level-card:hover {
        border-color: #4dd0e1;
        box-shadow: 0 10px 20px -5px rgba(0, 188, 212, 0.15), 0 4px 6px -4px rgba(0, 188, 212, 0.1);
    }
    
    /* Medalhas e Feitos */
    .achievements-card {
        background: linear-gradient(145deg, #ede7f6, #f8f5fb); /* Violeta/lil√°s claro */
        border-color: #b39ddb;
        border-left-color: #673ab7; /* Violeta vibrante */
        box-shadow: 0 4px 8px -2px rgba(103, 58, 183, 0.1), 0 2px 4px -2px rgba(103, 58, 183, 0.07);
    }
    .achievements-card .stat-card-title i {
        color: #512da8; /* Violeta escuro */
        background-color: #f3e5f5;
    }
    .achievements-list { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-top: 0.5rem; }
    .achievements-card:hover {
        border-color: #9575cd;
        box-shadow: 0 10px 20px -5px rgba(103, 58, 183, 0.15), 0 4px 6px -4px rgba(103, 58, 183, 0.1);
    }

    /* Card de Motiva√ß√£o Di√°ria (Novo) */
    .daily-motivation-card {
        background: linear-gradient(145deg, #f3e5f5, #fcf8fc); /* Roxo claro para o fundo */
        border-color: #ce93d8; /* Borda roxa clara */
        border-left-color: #ab47bc; /* Borda esquerda roxa vibrante */
        box-shadow: 0 4px 8px -2px rgba(171, 71, 188, 0.1), 0 2px 4px -2px rgba(171, 71, 188, 0.07);
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .daily-motivation-card .stat-card-title {
        justify-content: center;
        margin-bottom: 0.5rem;
    }
    .daily-motivation-card .stat-card-title i {
        color: #8e24aa; /* Roxo escuro para o √≠cone */
        background-color: #fce4ec; /* Fundo do √≠cone mais claro */
    }
    .daily-motivation-card:hover {
        border-color: #be93d8; /* Borda ao hover */
        box-shadow: 0 10px 20px -5px rgba(171, 71, 188, 0.15), 0 4px 6px -4px rgba(171, 71, 188, 0.1);
    }
    .motivation-date {
        font-size: 0.9rem;
        font-weight: 500;
        color: #8e24aa; /* Cor da data */
        margin-bottom: 0.75rem;
    }
    .motivation-text {
        font-size: 1.15rem; /* Frase um pouco maior */
        font-style: italic;
        color: #7b1fa2; /* Roxo mais escuro para a frase */
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 0.5rem;
    }


    /* Efeito de eleva√ß√£o adicionado ao container de filtro */
    .filter-container { background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }
    .filter-label { display: block; font-size: 0.875rem; font-weight: 500; color: #334155; margin-bottom: 0.5rem; }
    .filter-label i { color: #64748b; margin-right: 0.5rem; width: 16px; text-align: center; display: inline-block; }
    .custom-input { width: 100%; background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem; font-size: 0.875rem; color: #1e2937; transition: border-color 0.2s ease, box-shadow 0.2s ease; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    .custom-input::placeholder { color: #94a3b8; }
    .custom-input:focus { outline: none; border-color: #2563eb; background-color: #ffffff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
    select.custom-input { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
    
    .accordion-item { border-radius: 0.5rem; overflow: hidden; margin-bottom: 0.75rem; background-color: #fff; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03); }
    .accordion-header { padding: 1rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease; }
    .accordion-header:hover { background-color: #f8fafc; }
    .accordion-header .diploma-title { font-size: 1.125rem; font-weight: 600; color: #1e293b; display: flex; align-items: center; }
    .accordion-header .diploma-title .icon { margin-right: 0.75rem; color: #3b82f6; }
    .accordion-header .diploma-progress { display: flex; align-items: center; gap: 0.75rem; width: 30%; }
    .accordion-content { display: none; padding: 0.5rem 1.5rem 1.5rem 1.5rem; border-top: 1px solid #e2e8f0; background-color: #fdfdff; }
    
    .topic-item { display: flex; justify-content: space-between; align-items: center; padding: 0.85rem 1.25rem; border-bottom: 1px solid #f3f4f6; transition: background-color 0.2s ease; }
    .topic-item:first-child { border-top: 1px solid #e5e7eb; }
    .topic-item:last-child { border-bottom: none; }
    .topic-item:hover { background-color: #f3f4f6; }

    /* ===================================================================== */
    /* <<< IN√çCIO DA IMPLEMENTA√á√ÉO: LISTA DE LEIS MAIS LEG√çVEL >>> */
    /* ===================================================================== */

    /* Estilo para intercalar cores de fundo nos itens de t√≥pico (efeito zebra) */
    .topic-item:nth-child(even) {
        background-color: #e5e7eb; /* Cinza muito claro para linhas pares */
    }

    /* Garante que o hover sempre se sobreponha √† cor da linha */
    .topic-item:hover {
        background-color: #f3f4f6;
    }

    /* Cont√™iner do t√≠tulo do t√≥pico */
    .topic-info {
        display: flex;
        align-items: center;
        color: #334155;
        font-weight: 500;
        flex-grow: 1; /* Permite que o t√≠tulo ocupe o espa√ßo dispon√≠vel */
        margin-right: 1rem; /* Espa√ßo entre o t√≠tulo e os bot√µes */
    }

    .topic-info .icon {
        margin-right: 0.75rem;
        color: #94a3b8;
    }

    /* Novo cont√™iner para status e a√ß√µes, para melhor controle do alinhamento */
    .topic-status-and-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end; /* Alinha tudo √† direita */
        flex-shrink: 0; /* Impede que o container encolha */
    }

    /* Container do status para garantir largura fixa e alinhar bot√µes */
    .status-badge-container {
        min-width: 110px; /* Largura m√≠nima para caber "Em Andamento" confortavelmente */
        text-align: right;
        margin-right: 0.75rem; /* Espa√ßo entre o status (se houver) e os bot√µes */
    }

    /* Container apenas para os bot√µes */
    .main-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* ===================================================================== */
    /* <<< FIM DA IMPLEMENTA√á√ÉO: LISTA DE LEIS MAIS LEG√çVEL >>> */
    /* ===================================================================== */

    .accordion-toggle-icon { transition: transform 0.3s ease; transform: rotate(0deg); }
    .accordion-header.open .accordion-toggle-icon { transform: rotate(90deg); }
    .review-button { background-color: #6b7280; color: white; border: none; border-radius: 9999px; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s ease; }
    .review-button:hover { background-color: #4b5563; }
    .search-wrapper { position: relative; }
    .search-icon { position: absolute; top: 55%; left: 1rem; color: #94a3b8; transition: color 0.2s ease; }
    .search-input-with-icon { padding-left: 2.75rem !important; }
    .search-wrapper .search-input-with-icon:focus + .search-icon { color: #2563eb; }
    .search-wrapper .search-input-with-icon:focus { box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2), 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
    .autocomplete-container { position: absolute; background-color: white; border: 1px solid #e2e8f0; border-top: none; border-radius: 0 0 0.75rem 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); z-index: 1000; width: 100%; max-height: 400px; overflow-y: auto; display: none; }
    .autocomplete-item { padding: 0.75rem 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease; }
    .autocomplete-item:hover { background-color: #f8fafc; }
    .autocomplete-item-title { font-weight: 500; color: #1e293b; }
    .autocomplete-item-category { font-size: 0.75rem; font-weight: 600; padding: 0.2rem 0.5rem; border-radius: 10px; color: #1e40af; background-color: #dbeafe; }
    
    /* Efeito de eleva√ß√£o adicionado aos cards de favoritos */
    .favorite-card {
        background-color: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    .favorite-card:hover {
        box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.08);
        border-color: #d1d5db;
    }
    .favorite-card-header {
        padding: 1rem 1.25rem;
        cursor: pointer;
        background-color: #f9fafb;
    }
    .favorite-card-header-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
    }
    .favorite-card-header .toggle-icon {
        transition: transform 0.3s ease;
        color: #6b7280;
    }
    .favorite-card-header.open .toggle-icon {
        transform: rotate(180deg);
    }
    .favorite-card-progress {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 0.75rem;
    }
    .favorite-card-progress .progress-percentage {
        font-size: 0.875rem;
        font-weight: 600;
        color: #3b82f6;
        min-width: 40px;
        text-align: right;
    }
    .favorite-card-body {
        padding: 0; 
        display: none;
    }

    .favorites-grid-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    @media (min-width: 768px) {
        .favorites-grid-container {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .subject-accordion-item {
        background-color: #fff;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.03);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }
    .subject-accordion-header {
        padding: 1rem 1.5rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s ease;
    }
    .subject-accordion-header:hover {
        background-color: #f9fafb;
    }
    .subject-accordion-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
    }
    .subject-accordion-header .toggle-icon {
        transition: transform 0.3s ease;
        color: #3b82f6;
        font-size: 1.1rem;
    }
    .subject-accordion-content {
        display: none;
        padding: 0.5rem 1.5rem 1.5rem 1.5rem;
        border-top: 1px solid #e5e7eb;
    }
    .subject-accordion-header.open .toggle-icon {
        transform: rotate(180deg);
    }

    /* MEU DI√ÅRIO (TodoItem) */
    .todo-list-card {
        background: linear-gradient(145deg, #e0ffe0, #f0fff0); /* Verde claro */
        border-color: #a5d6a7;
        border-left-color: #4caf50; /* Verde vibrante */
        box-shadow: 0 4px 8px -2px rgba(76, 175, 80, 0.1), 0 2px 4px -2px rgba(76, 175, 80, 0.07);
    }
    .todo-list-card .stat-card-title i {
        color: #388e3c; /* Verde escuro */
        background-color: #e8f5e9;
    }
    .todo-list-card:hover {
        border-color: #81c784;
        box-shadow: 0 10px 20px -5px rgba(76, 175, 80, 0.15), 0 4px 6px -4px rgba(76, 175, 80, 0.1);
    }

    .todo-input-container {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .custom-input { width: 100%; background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem; font-size: 0.875rem; color: #1e2937; transition: border-color 0.2s ease, box-shadow 0.2s ease; -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    .custom-input::placeholder { color: #94a3b8; }
    .custom-input:focus { outline: none; border-color: #2563eb; background-color: #ffffff; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
    
    .todo-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px dashed #e0ffe0; /* Linha mais suave */
        transition: all 0.3s ease;
        position: relative; /* Essencial para posicionamento do tooltip */
    }
    .todo-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    .todo-item-content {
        display: flex;
        align-items: center;
        flex-grow: 1;
        cursor: pointer; /* Indica que o item √© clic√°vel */
    }
    .todo-item-content input[type="checkbox"] {
        margin-right: 0.75rem;
        /* Estilos b√°sicos para o checkbox, o Tailwind sobrescreve a apar√™ncia padr√£o */
        height: 1.25rem;
        width: 1.25rem;
        accent-color: #4caf50; /* Cor do checkmark */
        cursor: pointer;
    }
    .todo-item-text {
        font-size: 0.95rem;
        color: #374151;
        transition: color 0.3s ease;
        white-space: nowrap; /* Garante que o texto n√£o quebre linha */
        overflow: hidden; /* Esconde o excesso */
        text-overflow: ellipsis; /* Adiciona "..." */
        max-width: calc(100% - 2.5rem); /* Ajusta largura para caber checkbox e margem */
    }
    .todo-item.completed .todo-item-text {
        text-decoration: line-through;
        color: #9ca3af; /* Cinza para itens conclu√≠dos */
    }
    .todo-actions {
        flex-shrink: 0;
        margin-left: 0.75rem;
    }
    .todo-delete-btn {
        background: none;
        border: none;
        color: #ef4444; /* Vermelho para exclus√£o */
        cursor: pointer;
        font-size: 1.1rem;
        transition: color 0.2s ease;
    }
    .todo-delete-btn:hover {
        color: #dc2626;
    }
    /* Estilos para o input de adicionar tarefa */
    .todo-input-container .custom-input {
        flex-grow: 1;
        border-color: #a5d6a7; /* Borda verde clara */
    }
    .todo-input-container .custom-input:focus {
        border-color: #4caf50; /* Borda verde mais forte no focus */
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.15);
    }
    .todo-input-container .action-button {
        background-color: #4caf50; /* Bot√£o verde */
    }
    .todo-input-container .action-button:hover {
        background-color: #388e3c; /* Verde mais escuro no hover */
    }

    /* Estilo do tooltip para o texto completo da tarefa */
    .todo-item-text-tooltip {
        visibility: hidden;
        width: 250px; 
        background-color: rgba(0, 0, 0, 0.85);
        color: #fff;
        text-align: left; 
        border-radius: 6px;
        padding: 8px 12px;
        position: absolute; 
        z-index: 10;
        top: 100%; 
        left: 0; 
        transform: none; 
        margin-top: 5px; 
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8rem;
        pointer-events: none; 
        white-space: normal; 
        word-wrap: break-word; 
    }

    .todo-item-text-tooltip::after {
        content: "";
        position: absolute;
        bottom: 100%; 
        left: 20px; 
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: transparent transparent rgba(0, 0, 0, 0.85) transparent; 
    }

    .todo-item-text:hover + .todo-item-text-tooltip {
        visibility: visible;
        opacity: 1;
    }


    @media (max-width: 768px) {
        .todo-input-container {
            flex-direction: column;
            align-items: stretch;
        }
        .todo-input-container .action-button {
            width: 100%;
        }
    }

    /* Fim dos estilos do Meu Di√°rio */

    /* Estilos para ocultar/mostrar cards */
    .hidden-card-section {
        display: none;
    }

    @media (max-width: 768px) {
        .fixed-announcement-box, .announcement-box { padding: 1rem; }
        .non-fixed-announcement-item { gap: 0.75rem; }
        .fixed-announcement-box h2, .announcement-box h2 { font-size: 1.1rem; }
        .accordion-header .diploma-progress { display: none; }
    }
    
    /* IN√çCIO: Estilo para o bot√£o de editar t√≠tulo dos favoritos */
    #edit-favorites-title-btn {
        background: none;
        border: none;
        color: #9ca3af; /* Cinza claro */
        cursor: pointer;
        margin-left: 0.75rem;
        font-size: 0.9rem;
        padding: 0.25rem;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        line-height: 28px;
        text-align: center;
        transition: all 0.2s ease;
    }
    #edit-favorites-title-btn:hover {
        color: #4b5563; /* Cinza mais escuro */
        background-color: #f3f4f6; /* Fundo cinza claro no hover */
    }
    /* FIM: Estilo para o bot√£o de editar t√≠tulo dos favoritos */

    /* ===================================================================== */
    /* <<< FIM DAS ALTERA√á√ïES DE ESTILO >>> */
    /* ===================================================================== */

    /* ===================================================================== */
    /* <<< IN√çCIO DAS ALTERA√á√ïES DE ESTILO (JUN/2025): NOVA √ÅREA DE FILTRO >>> */
    /* ===================================================================== */
    
    /* Agrupamento visual do combo Mat√©ria + Lei */
    .filter-duo {
        display: grid;
        grid-template-columns: 1fr; /* mobile */
        gap: 1rem;
    }
    @media (min-width: 1024px) {
        .filter-duo {
            grid-template-columns: repeat(2, 1fr); /* lado-a-lado em telas grandes */
        }
    }

    /* Destaque para o cont√™iner de concurso */
    .filter-concurso {
        border-left: 4px solid #3b82f6;
        padding-left: 1rem;
        position: relative; /* Necess√°rio para posicionar o bot√£o de pino */
    }
    
    /* Destaque para o cont√™iner de Mat√©ria e Lei */
    .filter-materia-lei {
        border-left: 4px solid #f97316; /* Laranja vibrante */
        padding-left: 1rem;
    }

    /* --- IN√çCIO: Estilos para o bot√£o de Definir Concurso Padr√£o --- */
    #set-default-concurso-btn {
        display: none; /* Come√ßa oculto */
        position: absolute;
        top: 0;
        right: 0;
        background: none;
        border: none;
        cursor: pointer;
        color: #9ca3af; /* Cinza claro, indicando inativo */
        font-size: 1rem;
        padding: 0.25rem;
        transition: color 0.2s ease, transform 0.2s ease;
    }
    #set-default-concurso-btn:hover {
        color: #3b82f6; /* Azul no hover */
        transform: scale(1.1);
    }
    #set-default-concurso-btn.active {
        color: #3b82f6; /* Azul quando ativo */
    }
    #remove-default-concurso-btn {
        display: none; /* Come√ßa oculto */
        color: #ef4444; /* Vermelho */
        margin-left: 4px;
        font-weight: bold;
    }
    #set-default-concurso-btn.active + #remove-default-concurso-btn {
        display: inline; /* Mostra o "X" quando o pino est√° ativo */
    }
    /* --- FIM: Estilos para o bot√£o --- */

    /* ===================================================================== */
    /* <<< FIM DAS ALTERA√á√ïES DE ESTILO (JUN/2025) >>> */
    /* ===================================================================== */
    
    /* ===================================================================== */
    /* <<< IN√çCIO DA ALTERA√á√ÉO PARA VISUALIZA√á√ÉO MOBILE >>> */
    /* ===================================================================== */
    @media (max-width: 768px) {
        /* Altera o item principal para empilhar os elementos verticalmente */
        .topic-item {
            flex-direction: column; /* A m√°gica acontece aqui: muda a dire√ß√£o para vertical */
            align-items: flex-start; /* Alinha tudo √† esquerda */
            gap: 0.75rem; /* Cria um espa√ßo entre a √°rea do t√≠tulo e a √°rea dos bot√µes */
            padding: 1rem; /* Adiciona mais respiro interno */
        }

        /* Garante que o cont√™iner do t√≠tulo ocupe toda a largura */
        .topic-item .topic-info {
            display: flex;
            align-items: center;
            width: 100%;
            color: #334155;
            font-weight: 600; /* Deixa o t√≠tulo um pouco mais forte */
        }

        .topic-item .topic-info .icon {
            margin-right: 0.75rem;
            color: #94a3b8;
        }

        /* Nova div que agrupa a linha de baixo (status e a√ß√µes) */
        .topic-item .topic-status-and-actions {
            display: flex;
            justify-content: space-between; /* Empurra o status para a esquerda e as a√ß√µes para a direita */
            align-items: center;
            width: 100%; /* Ocupa toda a largura do card */
            padding-top: 0.5rem;
            border-top: 1px solid #f3f4f6; /* Adiciona uma linha sutil de separa√ß√£o */
        }
        
        /* Nova div que agrupa os bot√µes principais */
        .topic-status-and-actions .main-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* Espa√ßo entre o bot√£o de a√ß√£o e a estrela de favorito */
        }
        
        /* Ajusta o bot√£o de a√ß√£o principal para telas menores */
        .topic-status-and-actions .action-button {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem; /* Diminui um pouco o bot√£o */
        }

        /* Garante que os √≠cones dos bot√µes fiquem alinhados */
        .topic-status-and-actions .action-button i,
        .topic-status-and-actions .review-button i {
            margin-right: 0.3rem;
        }
    }
    /* ===================================================================== */
    /* <<< FIM DA ALTERA√á√ÉO PARA VISUALIZA√á√ÉO MOBILE >>> */
    /* ===================================================================== */

    /* ===================================================================== */
    /* <<< IN√çCIO DA NOVA IMPLEMENTA√á√ÉO: ESTILOS PARA NOVOS CARDS DE ESTUDO >>> */
    /* ===================================================================== */
    /* Estilos para o card de Tempo Total de Estudo */
    .total-study-time-card {
        background: linear-gradient(145deg, #e0f2f7, #f0faff); /* Azul claro */
        border-color: #81d4fa;
        border-left-color: #03a9f4; /* Azul vibrante */
        box-shadow: 0 4px 8px -2px rgba(3, 169, 244, 0.1), 0 2px 4px -2px rgba(3, 169, 244, 0.07);
        /* Garante que o card ocupe o espa√ßo dispon√≠vel verticalmente */
        display: flex;
        flex-direction: column;
        justify-content: space-around; /* Distribui o conte√∫do verticalmente */
    }
    .total-study-time-card .stat-card-title i {
        color: #0288d1; /* Azul escuro */
        background-color: #e3f2fd;
    }
    .total-study-time-card:hover {
        border-color: #4fc3f7;
        box-shadow: 0 10px 20px -5px rgba(3, 169, 244, 0.15), 0 4px 6px -4px rgba(3, 169, 244, 0.1);
    }
    /* Remover estilos antigos de .study-time-info e .study-time-today */
    .study-time-info, .study-time-today {
        margin-bottom: 0; /* Remove a margem inferior padr√£o */
        font-size: inherit; /* Garante que o font-size seja controlado pelas novas classes */
    }

    /* Novos estilos para cada item de tempo de estudo */
    .study-time-item {
        display: flex;
        justify-content: space-between; /* Alinha label √† esquerda e valor √† direita */
        align-items: center;
        padding: 0.4rem 0; /* Espa√ßamento vertical entre os itens */
        border-bottom: 1px dashed rgba(3, 169, 244, 0.2); /* Linha tracejada suave */
    }
    .study-time-item:last-child {
        border-bottom: none; /* Remove a borda do √∫ltimo item */
    }

    .study-time-label {
        font-size: 0.95rem; /* Tamanho da fonte para os r√≥tulos */
        font-weight: 700; /* T√≠tulos em negrito */
        color: #1c5e7f; /* Cor azul escuro para os r√≥tulos */
        flex-shrink: 0; /* Impede o r√≥tulo de encolher */
        margin-right: 1rem; /* Espa√ßo entre o r√≥tulo e o valor */
    }

    .study-time-value {
        font-size: 1.1rem; /* Tamanho da fonte para os valores */
        font-weight: 600; /* Valores em negrito */
        flex-grow: 1; /* Permite que o valor ocupe o espa√ßo restante */
        text-align: right; /* Alinha o valor √† direita */
    }

    /* Cores espec√≠ficas para cada valor de tempo */
    .study-time-total-value {
        color: #0288d1; /* Azul vibrante */
    }

    .study-time-weekly-value {
        color: #388e3c; /* Verde */
    }

    .study-time-daily-value {
        color: #ef6c00; /* Laranja/√¢mbar */
    }


    /* Estilos para o card de Estat√≠stica por Mat√©ria */
    .subject-stats-card {
        background: linear-gradient(145deg, #e8f5e9, #f5fcf5); /* Verde claro */
        border-color: #a5d6a7;
        border-left-color: #4caf50; /* Verde vibrante */
        box-shadow: 0 4px 8px -2px rgba(76, 175, 80, 0.1), 0 2px 4px -2px rgba(76, 175, 80, 0.07);
    }
    .subject-stats-card .stat-card-title i {
        color: #388e3c; /* Verde escuro */
        background-color: #e8f5e9;
    }
    .subject-stats-card:hover {
        border-color: #81c784;
        box-shadow: 0 10px 20px -5px rgba(76, 175, 80, 0.15), 0 4px 6px -4px rgba(76, 175, 80, 0.1);
    }
    .most-studied-text {
        font-size: 0.95rem;
        color: #1b5e20;
        margin-bottom: 0.75rem;
    }
    .chart-container {
        position: relative;
        height: 200px; /* Altura fixa para o gr√°fico */
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    /* Estilo para a mensagem quando n√£o h√° dados de estudo */
    .no-data-message {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 1rem;
        height: 100%; /* Garante que o cont√™iner ocupa a altura total do card */
        color: #6b7280;
    }

    .no-data-message i {
        font-size: 2.5rem;
        color: #9ca3af;
        margin-bottom: 1rem;
    }

    .no-data-message p {
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }

    .no-data-message small {
        font-size: 0.85rem;
        color: #9ca3af;
    }

    /* ===================================================================== */
    /* <<< FIM DA NOVA IMPLEMENTA√á√ÉO: ESTILOS PARA NOVOS CARDS DE ESTUDO >>> */
    /* ===================================================================== */


</style>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <div class="flex items-center justify-between"> {# Adiciona um cont√™iner flex para o t√≠tulo e o bot√£o #}
        <h1 class="text-3xl font-bold text-gray-800">Meu Painel</h1>
        {# Bot√£o de Ocultar Cards - Adicionado aqui #}
        <button id="toggle-cards-btn" class="action-button">
            <i class="fas fa-eye-slash mr-2"></i> Ocultar Cards
        </button>
    </div>

    {% if fixed_announcements or non_fixed_announcements %}
    <div class="announcement-section" id="announcement-cards-section"> {# Adicionado ID para a se√ß√£o de avisos #}
        {% if fixed_announcements %}
        <div class="announcement-container">
            <div class="fixed-announcement-box">
                {% for announcement in fixed_announcements %}
                <div class="fixed-announcement-item {% if not loop.first %}mt-3{% endif %}">
                    <h2><i class="fas fa-thumbtack"></i>{{ announcement.title }}</h2>
                    <div class="announcement-content rich-content">{{ announcement.content|safe }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% if non_fixed_announcements %}
        <div class="announcement-container" id="non-fixed-announcements-container">
            <div class="announcement-box">
                <h2><i class="fas fa-bullhorn"></i> Avisos Recentes</h2>
                {% for announcement in non_fixed_announcements %}
                <div class="non-fixed-announcement-item" data-announcement-id="{{ announcement.id }}">
                    <label class="mark-seen-checkbox-container">
                        <input type="checkbox" class="mark-seen-checkbox">
                        <span class="checkmark"></span>
                        <span class="tooltip">Marcar como visto</span>
                    </label>
                    <div class="announcement-content">
                        <h3 class="text-md font-semibold">{{ announcement.title }}</h3>
                        <div class="text-sm rich-content">{{ announcement.content|safe }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# ===================================================================== #}
    {# <<< IN√çCIO DA IMPLEMENTA√á√ÉO: ALTERA√á√ÉO DA ESTRUTURA DOS CARDS >>> #}
    {# ===================================================================== #}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="main-cards-grid"> {# Adicionado ID para o grid principal dos cards #}
        {# Meu Di√°rio (primeira coluna, ocupa 2 linhas) #}
        <div class="stat-card todo-list-card md:row-span-2"> 
            <h2 class="stat-card-title"><i class="fas fa-sticky-note"></i> Post-It</h2> {# Alterado o nome do card e o √≠cone #}
            <div class="todo-input-container">
                <input type="text" id="new-todo-item" placeholder="Adicionar nova tarefa..." class="custom-input">
                <button id="add-todo-btn" class="action-button">Adicionar</button>
            </div>
            <ul id="todo-list" class="space-y-1 flex-grow" style="max-height: 400px; overflow-y: hidden;"> {# Alterado de 'auto' para 'hidden' #}
                {# Os itens ser√£o carregados e renderizados via JavaScript #}
                {% if todo_items %}
                    {% for item in todo_items %}
                        <li class="todo-item {% if item.is_completed %}completed{% endif %}" data-item-id="{{ item.id }}">
                            <label class="todo-item-content">
                                <input type="checkbox" class="todo-checkbox" {% if item.is_completed %}checked{% endif %}>
                                {# Modifica√ß√£o para limitar o texto e adicionar tooltip #}
                                <span class="todo-item-text">{{ item.content|truncate(40, True) }}</span>
                                <span class="todo-item-text-tooltip">{{ item.content }}</span>
                            </label>
                            <div class="todo-actions">
                                <button type="button" class="todo-delete-btn" title="Excluir tarefa">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </li>
                    {% endfor %}
                {% else %}
                    <p id="no-todo-items-message" class="text-gray-500 italic text-sm text-center py-4">Nenhuma tarefa por enquanto. Adicione uma!</p>
                {% endif %}
            </ul>
        </div>

        {# Atividades Recentes (segunda coluna, primeira linha) #}
        {% if recent_activities %}
        <div class="stat-card recent-activities-card" id="recent-activities-card"> {# Adicionado ID #}
            <h2 class="stat-card-title"><i class="fas fa-history"></i> Atividades Recentes</h2>
            <div class="flex flex-col space-y-2">
                {% for activity in recent_activities %}
                <a href="{{ url_for('student.view_law', law_id=activity.law.id) }}" class="compact-activity-link">
                    <div class="compact-activity-content">
                        <span class="compact-activity-title" title="{{ activity.law.parent.title + ' - ' if activity.law.parent else '' }}{{ activity.law.title }}">
                            {{ activity.law.parent.title + ' - ' if activity.law.parent else '' }}{{ activity.law.title }}
                        </span>
                        <span class="compact-activity-time">{{ activity.time_ago }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {# Motiva√ß√£o Di√°ria (NOVO CARD - terceira coluna, primeira linha) #}
        <div class="stat-card daily-motivation-card" id="daily-motivation-card"> {# Adicionado ID #}
            <h2 class="stat-card-title"><i class="fas fa-brain"></i> Motiva√ß√£o Di√°ria</h2>
            <div id="motivation-date" class="motivation-date"></div>
            <p id="motivation-text" class="motivation-text"></p>
        </div>

        {# Sequ√™ncia de Estudos (segunda coluna, segunda linha) #}
        <div class="stat-card streak-card" id="streak-card"> {# Adicionado ID #}
            <h2 class="stat-card-title"><i class="fas fa-fire"></i> Sequ√™ncia de Estudos</h2>
            {% if user_streak > 0 %}
                <div class="streak-display">{{ user_streak }}</div>
                <p class="streak-text">dias consecutivos!</p>
            {% else %}
                <p class="text-gray-500 italic mt-2">Estude hoje para come√ßar uma nova sequ√™ncia! üî•</p>
            {% endif %}
        </div>

        {# Meu N√≠vel (terceira coluna, segunda linha) #}
        <div class="stat-card level-card" id="level-card"> {# Adicionado ID #}
            <h2 class="stat-card-title"><i class="fas fa-gem"></i> Meu N√≠vel</h2>
            <div class="level-info">
                <i class="{{ level_info.current_level.icon }} level-icon"></i>
                <div>
                    <div class="level-name">{{ level_info.current_level.name }}</div>
                    <div class="level-points">{{ user_points }} pontos</div>
                </div>
            </div>
            <div class="xp-bar-container">
                <div class="xp-bar-fill" style="width: {{ '%.2f'|format(level_info.progress_percent) }}%;"></div>
            </div>
            {% if level_info.next_level %}
                <p class="next-level-info">
                    Faltam <strong>{{ level_info.points_to_next }}</strong> pontos para <i class="{{ level_info.next_level.icon }}"></i> <strong>{{ level_info.next_level.name }}</strong>
                </p>
            {% else %}
                <p class="next-level-info">Parab√©ns! Voc√™ alcan√ßou o n√≠vel m√°ximo!</p>
            {% endif %}
        </div>

    </div>

    {# Medalhas e Feitos (agora acima dos cards de tempo e estat√≠stica, ocupando todas as colunas) #}
    <div class="stat-card achievements-card md:col-span-3" id="achievements-card"> {# Adicionado ID e classe para ocupar 3 colunas #}
        <h2 class="stat-card-title"><i class="fas fa-trophy"></i> Medalhas e Feitos</h2>
        {% if user_achievements %}
            <div class="achievements-list">
                {% for achievement in user_achievements %}
                    <span class="achievement-badge" title="{{ achievement.description }}">
                        <i class="{{ achievement.icon or 'fas fa-trophy' }}"></i> {{ achievement.name }}
                    </span>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-500 italic mt-2">Voc√™ ainda n√£o desbloqueou nenhuma medalha. Continue estudando!</p>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="study-stats-cards-grid"> {# Novo grid para os cards de estudo #}
        {# NOVO CARD: Tempo Total de Estudo (mant√©m a ocupa√ß√£o de 1 coluna) #}
        <div class="stat-card total-study-time-card md:col-span-1" id="total-study-time-card">
            <h2 class="stat-card-title"><i class="fas fa-clock"></i> Tempo Total de Estudo</h2>
            <div class="flex-grow flex flex-col justify-around"> {# Adiciona flex-grow e flex-col para espa√ßamento vertical #}
                <div class="study-time-item">
                    <span class="study-time-label">Total:</span>
                    <span class="study-time-value study-time-total-value">{{ total_study_formatted }}</span>
                </div>
                <div class="study-time-item">
                    <span class="study-time-label">Semanal:</span>
                    <span class="study-time-value study-time-weekly-value">{{ weekly_study_formatted }}</span>
                </div>
                <div class="study-time-item">
                    <span class="study-time-label">Hoje:</span>
                    <span class="study-time-value study-time-daily-value">{{ daily_study_formatted }}</span>
                </div>
            </div>
        </div>

        {# NOVO CARD: Estat√≠stica por Mat√©ria (mant√©m a ocupa√ß√£o de 2 colunas) #}
        <div class="stat-card subject-stats-card md:col-span-2" id="subject-stats-card">
            <h2 class="stat-card-title"><i class="fas fa-chart-pie"></i> Estat√≠stica por Mat√©ria</h2>
            {% if most_studied_subject %}
                <p class="most-studied-text">Sua mat√©ria mais estudada √© <strong>{{ most_studied_subject.name }}</strong> com <strong>{{ most_studied_subject.duration }}</strong>.</p>
                <div class="chart-container">
                    <canvas id="subjectStudyChart"></canvas>
                </div>
            {% else %}
                {# MENSAGEM MELHORADA QUANDO N√ÉO H√Å DADOS #}
                <div class="no-data-message">
                    <i class="fas fa-chart-bar"></i>
                    <p>Parece que voc√™ ainda n√£o tem estat√≠sticas de estudo!</p>
                    <small>Comece a estudar uma mat√©ria para ver seu progresso aqui.</small>
                    <a href="{{ url_for('student.laws') }}" class="action-button mt-4">
                        <i class="fas fa-book-reader mr-2"></i> Come√ßar a Estudar
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    {# ===================================================================== #}
    {# <<< FIM DA IMPLEMENTA√á√ÉO: ALTERA√á√ÉO DA ESTRUTURA DOS CARDS >>> #}
    {# ===================================================================== #}
    
    <div class="filter-container">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 mb-6">
            <div class="md:col-span-2 relative">
                <div class="relative search-wrapper">
                    <label for="search" class="filter-label">Busca R√°pida e Inteligente</label>
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="search" name="search" placeholder="Buscar por mat√©ria, lei ou artigo..." class="custom-input search-input-with-icon">
                </div>
                <div id="autocomplete-results" class="autocomplete-container"></div>
            </div>
            <div class="flex items-end pb-2">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="show_favorites" name="show_favorites" class="h-4 w-4 rounded border-gray-300">
                    <span class="ml-2 text-sm text-gray-700">Apenas favoritas</span>
                </label>
            </div>
        </div>
        <hr class="my-6 border-t border-gray-200">
        {# ===================================================================== #}
{# <<< IN√çCIO DA IMPLEMENTA√á√ÉO: ALTERA√á√ïES DO HTML DO FILTRO >>> #}
{# ===================================================================== #}
<div id="filter-controls" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-start">
    <div class="filter-concurso">
        <label for="concurso_id" class="filter-label">
            <i class="fas fa-trophy"></i> Filtrar por Concurso
            <button id="set-default-concurso-btn" title="Definir como filtro padr√£o">
                <i class="fas fa-thumbtack"></i>
            </button>
            <button id="remove-default-concurso-btn" title="Remover filtro padr√£o">
                &times;
            </button>
        </label>
        <select id="concurso_id" name="concurso_id" class="custom-input">
            <option value="all" selected>-- Todos os Concursos --</option>
            {% for concurso in concursos %}
                <option value="{{ concurso.id }}">{{ concurso.name }}</option>
            {% endfor %}
        </select>
        <div id="edital-button-container" class="mt-2">
            <a href="#" id="download-edital-btn" class="action-button" style="display: none; background-color: #3b82f6; width: 100%;" target="_blank">
                <i class="fas fa-download mr-2"></i> Baixar Edital Verticalizado
            </a>
        </div>
        </div>

    <div class="filter-materia-lei">
        <div class="filter-duo">
            <div>
                <label for="subject_id" class="filter-label text-xs lg:text-sm"><i class="fas fa-book-open"></i> Mat√©ria</label>
                <select id="subject_id" name="subject_id" class="custom-input">
                    {% if favorites_by_subject %}
                        <option value="" selected>-- Favoritas --</option>
                        <option value="all">-- Todas as Mat√©rias --</option>
                    {% else %}
                        <option value="all" selected>-- Todas as Mat√©rias --</option>
                    {% endif %}
                    {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="diploma_id" class="filter-label text-xs lg:text-sm"><i class="fas fa-gavel"></i> Lei</label>
                <select id="diploma_id" name="diploma_id" class="custom-input" disabled>
                    <option value="">-- Selecione uma Mat√©ria --</option>
                </select>
            </div>
        </div>
    </div>

    <div id="refinement-wrapper" style="visibility: hidden;">
        <label class="filter-label"><i class="fas fa-filter"></i> Refinar por</label>
        <div class="flex items-center space-x-4 mb-2">
            <label class="flex items-center text-sm cursor-pointer">
                <input type="radio" name="refine_type" value="status" class="h-4 w-4" checked>
                <span class="ml-1.5">Status</span>
            </label>
            <label class="flex items-center text-sm cursor-pointer">
                <input type="radio" name="refine_type" value="topic" class="h-4 w-4">
                <span class="ml-1.5">Trecho</span>
            </label>
        </div>
        <div id="status-filter-wrapper">
            <select id="status_filter" name="status_filter" class="custom-input">
                <option value="">-- Todos os Status --</option>
                <option value="not_read">N√£o Lidas</option>
                <option value="in_progress">Em Andamento</option>
                <option value="completed">Conclu√≠das</option>
            </select>
        </div>
        <div id="topic-filter-wrapper" style="display: none;">
             <select id="topic_filter" name="topic_filter" class="custom-input" disabled>
                <option value="">-- Selecione um Trecho --</option>
             </select>
        </div>
    </div>

    <div class="flex items-end">
        <label class="filter-label hidden lg:block">&nbsp;</label>
        <button type="button" id="clear-filters-btn" class="w-full flex items-center justify-center px-4 py-2.5 border border-gray-300 rounded-md text-sm text-gray-600 bg-white hover:bg-gray-50">Limpar Filtros</button>
    </div>
</div>
{# ===================================================================== #}
{# <<< FIM DA IMPLEMENTA√á√ÉO: ALTERA√á√ïES DO HTML DO FILTRO >>> #}
{# ===================================================================== #}
    </div>

    <div id="laws-section" style="display: none; opacity: 0; transition: opacity 0.5s ease-in-out;">
        <h2 id="laws-section-title" class="text-2xl font-semibold mb-6 text-gray-800 text-center">Legisla√ß√µes Dispon√≠veis</h2>
        <div id="laws-accordion-container"></div>
    </div>

    <div id="initial-prompt">
    
        {% if favorites_by_subject %}
            <div class="text-center mb-10">
                <h2 class="text-2xl font-semibold text-gray-800 flex items-center justify-center">
                    <i class="fas fa-star text-yellow-400 mr-3"></i>
                    <span id="favorites-title-text">{{ custom_favorite_title or 'Acesso R√°pido aos Seus Favoritos' }}</span>
                    <button id="edit-favorites-title-btn" title="Renomear esta se√ß√£o">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </h2>
            </div>

            <div id="favorite-cards-container">
                {% for subject, cards in favorites_by_subject.items()|sort(attribute='0.name') %}
                    <div class="subject-accordion-item">
                        <div class="subject-accordion-header">
                            <h3>{{ subject.name }}</h3>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                        <div class="subject-accordion-content">
                            <div class="favorites-grid-container">
                                {% for card in cards|sort(attribute='parent.title') %}
                                    <div class="favorite-card">
                                        <div class="favorite-card-header">
                                            <div class="favorite-card-header-title">
                                                <span>{{ card.parent.title }}</span>
                                                <i class="fas fa-chevron-down toggle-icon"></i>
                                            </div>
                                            <div class="favorite-card-progress">
                                                <div class="progress-bar-container">
                                                    <div class="progress-bar-fill" style="width: {{ card.progress }}%;"></div>
                                                </div>
                                                <span class="progress-percentage">{{ "%.0f"|format(card.progress) }}%</span>
                                            </div>
                                        </div>
                                        <div class="favorite-card-body">
                                            {% for topic in card.topics|sort(attribute='title') %}
                                                <div class="topic-item" data-law-id="{{ topic.id }}">
                                                    <div class="topic-info">
                                                        <i class="fas fa-file-alt icon"></i>
                                                        <span>{{ topic.title }}</span>
                                                    </div>
                                                    
                                                    <div class="topic-status-and-actions">
                                                        <div class="status-badge-container">
                                                            {% if topic.is_completed %}
                                                                <span class="completed-badge">Conclu√≠da</span>
                                                            {% elif topic.is_in_progress %}
                                                                <span class="in-progress-badge">Em Andamento</span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="main-actions">
                                                            <a href="{{ url_for('student.view_law', law_id=topic.id) }}" class="action-button">
                                                                {% if topic.is_completed %}
                                                                    <i class="fas fa-check-circle mr-1"></i> Revisar
                                                                {% elif topic.is_in_progress %}
                                                                    <i class="fas fa-book-reader mr-1"></i> Continuar
                                                                {% else %}
                                                                    <i class="fas fa-book mr-1"></i> Come√ßar
                                                                {% endif %}
                                                            </a>
                                                            {% if topic.is_completed %}
                                                            <button type="button" class="review-button js-mark-incomplete-btn" data-law-id="{{ topic.id }}" title="Marcar como n√£o conclu√≠do">
                                                                <i class="fas fa-undo-alt"></i>
                                                            </button>
                                                            {% endif %}
                                                            <button type="button" class="favorite-btn js-favorite-btn favorited" data-law-id="{{ topic.id }}" title="Remover dos Favoritos">
                                                                <i class="fas fa-star"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

        {% else %}
            <div class="text-center py-12 px-6 bg-white rounded-lg border border-dashed">
                <i class="fas fa-filter text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700">Comece seus estudos!</h3>
                <p class="text-gray-500 mt-2">Selecione uma mat√©ria nos filtros acima para ver as legisla√ß√µes dispon√≠veis.</p>
            </div>
        {% endif %}
        </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
{# <<< NOVO: Importa a biblioteca Chart.js para gr√°ficos >>> #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMENTOS DO DOM ---
    const filterControls = {
        search: document.getElementById('search'),
        concurso: document.getElementById('concurso_id'),
        subject: document.getElementById('subject_id'),
        diploma: document.getElementById('diploma_id'),
        favorites: document.getElementById('show_favorites'),
        clearButton: document.getElementById('clear-filters-btn'),
        refinementWrapper: document.getElementById('refinement-wrapper'),
        refineTypeRadios: document.querySelectorAll('input[name="refine_type"]'),
        statusFilterWrapper: document.getElementById('status-filter-wrapper'),
        topicFilterWrapper: document.getElementById('topic-filter-wrapper'),
        statusFilter: document.getElementById('status_filter'),
        topicFilter: document.getElementById('topic_filter'),
    };
    const csrfToken = '{{ csrf_token() }}';
    let debounceTimer;

    const lawsSection = document.getElementById('laws-section');
    const lawsSectionTitle = document.getElementById('laws-section-title');
    const initialPrompt = document.getElementById('initial-prompt');
    const accordionContainer = document.getElementById('laws-accordion-container');
    
    const setDefaultConcursoBtn = document.getElementById('set-default-concurso-btn');
    const removeDefaultConcursoBtn = document.getElementById('remove-default-concurso-btn');
    const defaultConcursoId = {{ default_concurso_id|tojson }};
    
    // =====================================================================
    // <<< IN√çCIO DA IMPLEMENTA√á√ÉO: L√≥gica para o bot√£o de download do edital >>>
    // =====================================================================
    const editalButton = document.getElementById('download-edital-btn');

    function checkEdital(concursoId) {
        // Esconde o bot√£o por padr√£o sempre que a fun√ß√£o for chamada
        if (editalButton) {
            editalButton.style.display = 'none';
        }

        if (concursoId && concursoId !== 'all' && editalButton) {
            fetch(`/student/api/concurso/${concursoId}/details`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.edital_url) {
                        editalButton.href = data.edital_url;
                        editalButton.style.display = 'inline-flex'; // Mostra o bot√£o como flex√≠vel
                    }
                })
                .catch(error => console.error('Erro ao buscar detalhes do edital:', error));
        }
    }
    // =====================================================================
    // <<< FIM DA IMPLEMENTA√á√ÉO >>>
    // =====================================================================

    function updateLawsTitle(concursoSelectElement) {
        const selectedOption = concursoSelectElement.options[concursoSelectElement.selectedIndex];
        if (concursoSelectElement.value && concursoSelectElement.value !== 'all') {
            lawsSectionTitle.textContent = ` ${selectedOption.text}`;
        } else {
            lawsSectionTitle.textContent = 'Legisla√ß√µes Dispon√≠veis';
        }
    }

    function updateDefaultConcursoButtonState() {
        const selectedConcursoId = filterControls.concurso.value;
        const isDefault = selectedConcursoId && selectedConcursoId == defaultConcursoId;

        if (selectedConcursoId && selectedConcursoId !== 'all') {
            setDefaultConcursoBtn.style.display = 'inline-block';
            if (isDefault) {
                setDefaultConcursoBtn.classList.add('active');
            } else {
                setDefaultConcursoBtn.classList.remove('active');
            }
        } else {
            setDefaultConcursoBtn.style.display = 'none';
        }
    }

    setDefaultConcursoBtn.addEventListener('click', function() {
        const concursoId = filterControls.concurso.value;
        if (!concursoId || concursoId === 'all') return;

        fetch('/student/api/set_default_concurso', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ concurso_id: concursoId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Toastify({ text: data.message, duration: 3000, style: { background: "linear-gradient(to right, #4caf50, #66bb6a)" } }).showToast();
                window.location.reload();
            } else {
                Toastify({ text: data.error, duration: 3000, style: { background: "linear-gradient(to right, #ff416c, #ff4b2b)" } }).showToast();
            }
        });
    });

    removeDefaultConcursoBtn.addEventListener('click', function() {
        fetch('/student/api/set_default_concurso', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ concurso_id: 'clear' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Toastify({ text: data.message, duration: 3000, style: { background: "linear-gradient(to right, #4caf50, #66bb6a)" } }).showToast();
                window.location.reload();
            } else {
                Toastify({ text: data.error, duration: 3000, style: { background: "linear-gradient(to right, #ff416c, #ff4b2b)" } }).showToast();
            }
        });
    });

    filterControls.concurso.addEventListener('change', () => {
        showLawsSection();
        updateLawsTitle(filterControls.concurso);
        updateDefaultConcursoButtonState();
        
        // <<< IN√çCIO DA IMPLEMENTA√á√ÉO: Chama a fun√ß√£o para checar o edital >>>
        checkEdital(filterControls.concurso.value);
        // <<< FIM DA IMPLEMENTA√á√ÉO >>>

        if (filterControls.concurso.value !== 'all') {
            filterControls.subject.value = '';
        }
        updateDiplomaFilter(null, filterControls.concurso.value);
    });

    function showLawsSection() {
        if (lawsSection.style.display === 'none') {
            initialPrompt.style.display = 'none';
            lawsSection.style.display = 'block';
            setTimeout(() => lawsSection.style.opacity = '1', 50);
        }
    }

    const newTodoItemInput = document.getElementById('new-todo-item');
    const addTodoBtn = document.getElementById('add-todo-btn');
    const todoListUl = document.getElementById('todo-list');
    const noTodoItemsMessage = document.getElementById('no-todo-items-message');
    const motivationDateElement = document.getElementById('motivation-date');
    const motivationTextElement = document.getElementById('motivation-text');
    const favoritesTitleText = document.getElementById('favorites-title-text');
    const editFavoritesTitleBtn = document.getElementById('edit-favorites-title-btn');

    if (editFavoritesTitleBtn) {
        editFavoritesTitleBtn.addEventListener('click', function() {
            const currentTitle = favoritesTitleText.textContent;
            const newTitle = prompt("Digite o novo nome para esta se√ß√£o:", currentTitle);

            if (newTitle !== null && newTitle.trim() !== '') {
                const finalTitle = newTitle.trim();
                
                favoritesTitleText.textContent = finalTitle;

                fetch('/student/api/save_favorite_title', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ title: finalTitle })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Toastify({ text: data.message, duration: 3000, style: { background: "linear-gradient(to right, #4caf50, #66bb6a)" } }).showToast();
                    } else {
                        favoritesTitleText.textContent = currentTitle;
                        Toastify({ text: data.error, duration: 3000, style: { background: "linear-gradient(to right, #ff416c, #ff4b2b)" } }).showToast();
                    }
                })
                .catch(error => {
                    favoritesTitleText.textContent = currentTitle;
                    console.error('Erro de rede:', error);
                    Toastify({ text: "Erro de comunica√ß√£o. Tente novamente.", duration: 3000, style: { background: "linear-gradient(to right, #ff416c, #ff4b2b)" } }).showToast();
                });
            }
        });
    }

    const toggleCardsBtn = document.getElementById('toggle-cards-btn');
    const cardsToToggle = [
        document.getElementById('announcement-cards-section'),
        document.querySelector('.todo-list-card'),
        document.getElementById('recent-activities-card'),
        document.getElementById('daily-motivation-card'),
        document.getElementById('streak-card'),
        document.getElementById('level-card'),
        document.getElementById('achievements-card'),
        // <<< NOVO: Adiciona o grid dos cards de estudo para ser ocultado/mostrado >>>
        document.getElementById('study-stats-cards-grid') 
        // <<< FIM NOVO >>>
    ];

    function applyCardsVisibility(hidden) {
        cardsToToggle.forEach(card => {
            if (card) {
                if (hidden) {
                    card.classList.add('hidden-card-section');
                } else {
                    card.classList.remove('hidden-card-section');
                }
            }
        });
        
        if (hidden) {
            toggleCardsBtn.innerHTML = '<i class="fas fa-eye mr-2"></i> Mostrar Cards';
        } else {
            toggleCardsBtn.innerHTML = '<i class="fas fa-eye-slash mr-2"></i> Ocultar Cards';
        }
        localStorage.setItem('hideCards', hidden);
    }

    const savedHideCardsPreference = localStorage.getItem('hideCards') === 'true';
    applyCardsVisibility(savedHideCardsPreference);

    toggleCardsBtn.addEventListener('click', function() {
        const isCurrentlyHidden = localStorage.getItem('hideCards') === 'true';
        applyCardsVisibility(!isCurrentlyHidden);
    });

    async function fetchAndRenderLaws() {
        const subjectId = filterControls.subject.value;
        const concursoId = filterControls.concurso.value;
        const diplomaId = filterControls.diploma.value;
        const showFavorites = filterControls.favorites.checked;
        const refineType = document.querySelector('input[name="refine_type"]:checked').value;
        
        const isInitialState = !subjectId && (concursoId === 'all' || !concursoId);
        if (isInitialState && !showFavorites) {
             accordionContainer.innerHTML = '';
             return;
        }

        accordionContainer.innerHTML = '<p class="text-center py-8 text-gray-500">Carregando...</p>';

        const params = new URLSearchParams();
        if (showFavorites) params.append('show_favorites', 'true');

        if (concursoId && concursoId !== 'all') {
            params.append('concurso_id', concursoId);
        } else if (subjectId && subjectId !== 'all') {
             params.append('subject_id', subjectId);
        }
        
        if (diplomaId) {
            params.append('diploma_id', diplomaId);
            if (refineType === 'status') {
                if (filterControls.statusFilter.value) {
                    params.append('status_filter', filterControls.statusFilter.value);
                }
            } else {
                if (filterControls.topicFilter.value) {
                    params.append('topic_id', filterControls.topicFilter.value);
                }
            }
        }
        
        try {
            const response = await fetch(`/student/filter_laws?${params.toString()}`);
            if (!response.ok) throw new Error('Falha na resposta do servidor.');
            
            const data = await response.json();
            renderLaws(data.subjects_with_diplomas);
        } catch (error) {
            console.error('Erro ao buscar leis:', error);
            accordionContainer.innerHTML = '<p class="text-center py-8 text-red-500">Ocorreu um erro ao carregar as legisla√ß√µes. Tente novamente.</p>';
        }
    }
    
    async function updateDiplomaFilter(subjectId, concursoId) {
        filterControls.diploma.innerHTML = '<option value="">-- Selecione uma Mat√©ria --</option>';
        filterControls.diploma.disabled = true;
        
        filterControls.refinementWrapper.style.visibility = 'hidden';
        filterControls.statusFilter.value = '';
        await updateTopicFilter(null);

        if (concursoId && concursoId !== 'all') {
            fetchAndRenderLaws();
            return;
        }

        if (!subjectId || subjectId === 'all') {
            fetchAndRenderLaws();
            return;
        }
        
        filterControls.diploma.innerHTML = '<option value="">Carregando leis...</option>';
        try {
            const response = await fetch(`/student/api/laws_for_subject/${subjectId}`);
            const laws = await response.json();

            filterControls.diploma.innerHTML = '<option value="">-- Todas as Leis da Mat√©ria --</option>';
            laws.forEach(law => {
                const option = new Option(law.title, law.id);
                filterControls.diploma.appendChild(option);
            });
            filterControls.diploma.disabled = false;
        } catch (error) {
            console.error("Erro ao buscar leis:", error);
            filterControls.diploma.innerHTML = '<option value="">Erro ao carregar</option>';
        }
        fetchAndRenderLaws();
    }

    async function updateTopicFilter(lawId) {
        const topicSelect = filterControls.topicFilter;
        topicSelect.innerHTML = '<option value="">-- Selecione um Trecho --</option>';
        topicSelect.disabled = true;

        if (!lawId) return;
        
        topicSelect.innerHTML = '<option value="">Carregando trechos...</option>';
        try {
            const response = await fetch(`/student/api/topics_for_law/${lawId}`);
            if (!response.ok) throw new Error('Falha ao buscar trechos.');
            const topics = await response.json();

            topicSelect.innerHTML = '<option value="">-- Todos os Trechos --</option>';
            topics.forEach(topic => {
                const option = new Option(topic.title, topic.id);
                topicSelect.appendChild(option);
            });
            topicSelect.disabled = false;
        } catch (error) {
            console.error("Erro ao buscar trechos:", error);
            topicSelect.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }

    function renderLaws(subjects) {
        if (Object.keys(subjects).length === 0) {
            accordionContainer.innerHTML = '<div class="text-center py-8"><p class="text-gray-500 italic">Nenhuma legisla√ß√£o encontrada com os filtros selecionados.</p></div>';
            return;
        }

        let html = '';
        const sortedSubjectNames = Object.keys(subjects).sort((a, b) => a.localeCompare(b));

        for (const subjectName of sortedSubjectNames) {
            const sortedDiplomas = subjects[subjectName].sort((a, b) => a.title.localeCompare(b.title));

            html += `
            <div class="subject-accordion-item">
                <div class="subject-accordion-header">
                    <h3>${subjectName}</h3>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="subject-accordion-content">
                    ${sortedDiplomas.map(diploma => {
                        const sortedTopics = diploma.filtered_children.sort((a, b) => a.title.localeCompare(b.title));
                        return `
                        <div class="accordion-item mt-3 first:mt-0">
                            <div class="accordion-header">
                                <div class="diploma-title"><i class="fas fa-gavel icon"></i><span>${diploma.title}</span></div>
                                <div class="diploma-progress">
                                    <div class="progress-bar-container w-full"><div class="progress-bar-fill" style="width: ${diploma.progress_percentage || 0}%;"></div></div>
                                    <span class="text-sm font-bold" style="color: #2563eb;">${Math.round(diploma.progress_percentage || 0)}%</span>
                                    <i class="fas fa-chevron-right accordion-toggle-icon"></i>
                                </div>
                            </div>
                            <div class="accordion-content" style="display: none;">
                                ${sortedTopics.length > 0 ? sortedTopics.map(topic => renderTopicItem(topic)).join('') : '<p class="text-gray-500 italic text-center py-4">Nenhum t√≥pico de estudo encontrado.</p>'}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }
        accordionContainer.innerHTML = html;
        attachEventListeners();
    }
    
    function renderTopicItem(topic) {
        let statusBadge = '';
        if (topic.is_completed) {
            statusBadge = '<span class="completed-badge">Conclu√≠da</span>';
        } else if (topic.is_in_progress) {
            statusBadge = '<span class="in-progress-badge">Em Andamento</span>';
        }

        let actionButtonText = '';
        if (topic.is_completed) {
            actionButtonText = '<i class="fas fa-check-circle mr-1"></i> Revisar';
        } else if (topic.is_in_progress) {
            actionButtonText = '<i class="fas fa-book-reader mr-1"></i> Continuar';
        } else {
            actionButtonText = '<i class="fas fa-book mr-1"></i> Come√ßar';
        }

        const reviewButton = topic.is_completed ? `
            <button type="button" class="review-button js-mark-incomplete-btn" data-law-id="${topic.id}" title="Marcar como n√£o conclu√≠do">
                <i class="fas fa-undo-alt"></i>
            </button>` : '';
        
        const favoriteClass = topic.is_favorite ? 'favorited' : '';
        const favoriteIcon = 'fas fa-star';
        const favoriteTitle = topic.is_favorite ? 'Remover dos Favoritos' : 'Adicionar aos Favoritos';

        // Nova estrutura HTML que usa os novos cont√™ineres para alinhamento.
        return `
        <div class="topic-item" data-law-id="${topic.id}">
            <div class="topic-info">
                <i class="fas fa-file-alt icon"></i>
                <span>${topic.title}</span>
            </div>
            <div class="topic-status-and-actions">
                <div class="status-badge-container">
                    ${statusBadge}
                </div>
                <div class="main-actions">
                    <a href="/student/law/${topic.id}" class="action-button">${actionButtonText}</a>
                    ${reviewButton}
                    <button type="button" class="favorite-btn js-favorite-btn ${favoriteClass}" data-law-id="${topic.id}" title="${favoriteTitle}">
                        <i class="${favoriteIcon}"></i>
                    </button>
                </div>
            </div>
        </div>`;
    }

    function attachEventListeners() {
        document.querySelectorAll('.subject-accordion-header, .accordion-header, .favorite-card-header').forEach(header => {
            header.addEventListener('click', function(event) {
                if (header.classList.contains('accordion-header')) event.stopPropagation();
                
                this.classList.toggle('open');
                const content = this.nextElementSibling;
                const icon = this.querySelector('.toggle-icon, .accordion-toggle-icon');
                if (content.style.display === 'block') {
                    content.style.display = 'none';
                    if (icon) icon.style.transform = 'rotate(0deg)';
                } else {
                    content.style.display = 'block';
                    if (icon) icon.style.transform = icon.classList.contains('accordion-toggle-icon') ? 'rotate(90deg)' : 'rotate(180deg)';
                }
            });
        });

        document.querySelectorAll('.js-favorite-btn').forEach(button => button.addEventListener('click', handleFavoriteClick));
        document.querySelectorAll('.js-mark-incomplete-btn').forEach(button => button.addEventListener('click', handleMarkIncompleteClick));
        todoListUl.querySelectorAll('.todo-checkbox').forEach(checkbox => checkbox.addEventListener('change', handleToggleTodoItem));
        todoListUl.querySelectorAll('.todo-delete-btn').forEach(button => button.addEventListener('click', handleDeleteTodoItem));
    }

    filterControls.subject.addEventListener('change', () => {
        const subjectId = filterControls.subject.value;
        if (subjectId === '') {
            initialPrompt.style.display = 'block';
            lawsSection.style.display = 'none';
            lawsSection.style.opacity = '0';
        } else {
            showLawsSection();
        }
        filterControls.concurso.value = 'all';
        updateDefaultConcursoButtonState();
        updateLawsTitle(filterControls.concurso);
        filterControls.search.value = '';
        updateDiplomaFilter(subjectId, null);
        
        // <<< IN√çCIO DA IMPLEMENTA√á√ÉO: Esconde o bot√£o do edital >>>
        checkEdital(null);
        // <<< FIM DA IMPLEMENTA√á√ÉO >>>
    });

    filterControls.diploma.addEventListener('change', async () => {
        filterControls.search.value = '';
        const diplomaId = filterControls.diploma.value;
        filterControls.refinementWrapper.style.visibility = diplomaId ? 'visible' : 'hidden';
        await updateTopicFilter(diplomaId);
        fetchAndRenderLaws();
    });

    filterControls.refineTypeRadios.forEach(radio => radio.addEventListener('change', () => {
        const isStatus = radio.value === 'status';
        filterControls.statusFilterWrapper.style.display = isStatus ? 'block' : 'none';
        filterControls.topicFilterWrapper.style.display = isStatus ? 'none' : 'block';
        filterControls.topicFilter.value = isStatus ? '' : filterControls.topicFilter.value;
        filterControls.statusFilter.value = !isStatus ? '' : filterControls.statusFilter.value;
        fetchAndRenderLaws();
    }));
    
    filterControls.statusFilter.addEventListener('change', fetchAndRenderLaws);
    filterControls.topicFilter.addEventListener('change', fetchAndRenderLaws);
    
    filterControls.favorites.addEventListener('change', () => {
        const isChecked = filterControls.favorites.checked;
        if (isChecked) {
             showLawsSection();
        } else if (filterControls.subject.value === '' && (filterControls.concurso.value === 'all' || !filterControls.concurso.value)) {
             initialPrompt.style.display = 'block';
             lawsSection.style.display = 'none';
             lawsSection.style.opacity = '0';
        }
       fetchAndRenderLaws();
    });

    filterControls.clearButton.addEventListener('click', () => {
        filterControls.search.value = '';
        const hasFavorites = document.querySelector('#favorite-cards-container .favorite-card') !== null;
        
        filterControls.concurso.value = 'all';
        filterControls.subject.value = hasFavorites ? '' : 'all';
        
        filterControls.diploma.innerHTML = '<option value="">-- Selecione uma Mat√©ria --</option>';
        filterControls.diploma.disabled = true;
        filterControls.favorites.checked = false;
        
        filterControls.refinementWrapper.style.visibility = 'hidden';
        document.querySelector('input[name="refine_type"][value="status"]').checked = true;
        filterControls.statusFilterWrapper.style.display = 'block';
        filterControls.topicFilterWrapper.style.display = 'none';
        filterControls.statusFilter.value = '';
        updateTopicFilter(null);
        
        updateLawsTitle(filterControls.concurso);
        updateDefaultConcursoButtonState();
        
        // <<< IN√çCIO DA IMPLEMENTA√á√ÉO: Esconde o bot√£o do edital >>>
        checkEdital(null);
        // <<< FIM DA IMPLEMENTA√á√ÉO >>>

        if (hasFavorites) {
            initialPrompt.style.display = 'block';
            lawsSection.style.display = 'none';
            lawsSection.style.opacity = '0';
            accordionContainer.innerHTML = '';
        } else {
            initialPrompt.style.display = 'block';
            lawsSection.style.display = 'none';
        }
    });

    const searchInput = document.getElementById('search');
    const resultsContainer = document.getElementById('autocomplete-results');
    let searchDebounceTimer;

    searchInput.addEventListener('input', () => {
        clearTimeout(searchDebounceTimer);
        const query = searchInput.value;

        if (query.length < 3) {
            resultsContainer.style.display = 'none';
            return;
        }
        
        filterControls.subject.value = 'all';
        filterControls.diploma.innerHTML = '<option value="">-- Selecione uma Mat√©ria --</option>';
        filterControls.diploma.disabled = true;
        filterControls.refinementWrapper.style.visibility = 'hidden';
        
        initialPrompt.style.display = 'none';
        lawsSection.style.display = 'none';

        searchDebounceTimer = setTimeout(() => {
            fetch(`/student/api/autocomplete_search?q=${query}`)
                .then(response => response.json())
                .then(data => renderAutocompleteResults(data.results));
        }, 300);
    });

    function renderAutocompleteResults(results) {
        resultsContainer.innerHTML = !results || results.length === 0 ? '<div class="autocomplete-item"><span class="autocomplete-item-title">Nenhum resultado encontrado.</span></div>' : 
            results.map(item => `
                <div class="autocomplete-item" onclick="window.location.href='${item.url}'">
                    <span class="autocomplete-item-title">${item.title}</span>
                    <span class="autocomplete-item-category">${item.category}</span>
                </div>
            `).join('');
        resultsContainer.style.display = 'block';
    }

    document.addEventListener('click', event => {
        if (!document.querySelector('.search-wrapper')?.contains(event.target)) {
            resultsContainer.style.display = 'none';
        }
    });

    function setupDynamicPlaceholder() {
        if (!searchInput) return;
        const placeholders = ["Busque por 'C√≥digo Penal'...", "Tente 'Direito Administrativo'...", "Digite 'Art. 5¬∫ da Constitui√ß√£o'...", "Qual legisla√ß√£o voc√™ procura hoje?", "Busque por S√∫mulas ou T√≥picos..."];
        let currentIndex = 0;
        setInterval(() => {
            currentIndex = (currentIndex + 1) % placeholders.length;
            searchInput.placeholder = placeholders[currentIndex];
        }, 3000);
    }
    setupDynamicPlaceholder();

    document.querySelectorAll('.mark-seen-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            this.disabled = true;
            const announcementItem = this.closest('.non-fixed-announcement-item');
            const announcementId = announcementItem.dataset.announcementId;
            fetch(`/student/announcement/${announcementId}/mark_seen`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    announcementItem.classList.add('fade-out');
                    setTimeout(() => {
                        announcementItem.remove();
                        if (document.querySelectorAll('.non-fixed-announcement-item').length === 0) {
                            document.getElementById('non-fixed-announcements-container')?.remove();
                        }
                    }, 500);
                } else { this.checked = false; this.disabled = false; }
            })
            .catch(() => { this.checked = false; this.disabled = false; });
        });
    });

    function handleFavoriteClick(event) {
        const button = event.currentTarget;
        button.disabled = true;
        const lawId = button.dataset.lawId;
        const icon = button.querySelector('i');
        const topicItem = button.closest('.topic-item'); 
        const topicInfo = topicItem ? topicItem.querySelector('.topic-info span') : null;
        const topicTitle = topicInfo ? topicInfo.textContent : 'Item';

        fetch(`/student/law/toggle_favorite/${lawId}`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }})
        .then(response => response.json())
        .then(data => {
            let notificationText;
            if (data.favorited) {
                button.classList.add('favorited');
                icon.className = 'fas fa-star';
                button.title = 'Remover dos Favoritos';
                notificationText = `'${topicTitle}' adicionado aos favoritos!`;
            } else {
                button.classList.remove('favorited');
                icon.className = 'far fa-star';
                button.title = 'Adicionar aos Favoritos';
                notificationText = `'${topicTitle}' removido dos favoritos.`;
                if (button.closest('#initial-prompt')) {
                    const topicToRemove = button.closest('.topic-item');
                    if (topicToRemove) {
                         const card = topicToRemove.closest('.favorite-card');
                         topicToRemove.remove();
                         if (!card.querySelector('.topic-item')) {
                            const subjectContainer = card.closest('.subject-accordion-item');
                            card.remove();
                            if (!subjectContainer.querySelector('.favorite-card')) {
                                subjectContainer.remove();
                            }
                            if (!document.querySelector('#favorite-cards-container .subject-accordion-item')) {
                                window.location.reload();
                            }
                         }
                    }
                } else if (filterControls.favorites.checked) {
                    fetchAndRenderLaws();
                }
            }
            Toastify({ text: notificationText, duration: 3000, style: { background: "linear-gradient(to right, #1f2937, #374151)" } }).showToast();
        })
        .finally(() => { button.disabled = false; });
    }

    function handleMarkIncompleteClick(event) {
        const buttonEl = event.currentTarget;
        buttonEl.disabled = true;
        const lawId = buttonEl.dataset.lawId;
        fetch(`/student/law/review/${lawId}`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }})
        .then(response => response.json())
        .then(data => {
            if (data.success && data.new_status === 'em_andamento') {
                 if (buttonEl.closest('#initial-prompt')) {
                    window.location.reload();
                } else {
                    fetchAndRenderLaws();
                }
            } else { buttonEl.disabled = false; }
        })
        .catch(() => buttonEl.disabled = false);
    }
    
    function initializeDashboard() {
        attachEventListeners();
        
        if (defaultConcursoId) {
            filterControls.concurso.value = defaultConcursoId;
            filterControls.concurso.dispatchEvent(new Event('change'));
        } else if (filterControls.subject.value === 'all') {
            showLawsSection();
            fetchAndRenderLaws();
        } else {
            // <<< IN√çCIO DA IMPLEMENTA√á√ÉO: Checa o edital no carregamento inicial se n√£o houver concurso padr√£o >>>
            checkEdital(filterControls.concurso.value);
            // <<< FIM DA IMPLEMENTA√á√ÉO >>>
        }
        
        updateDefaultConcursoButtonState();
        fetchAndRenderTodoItems();
        displayDailyMotivation();
        setupDynamicPlaceholder();
        // <<< NOVO: Inicializa o gr√°fico de estudo por mat√©ria >>>
        initializeSubjectStudyChart();
        // <<< FIM NOVO >>>
    }
    
    async function fetchAndRenderTodoItems() {
        try {
            const response = await fetch('/student/api/todo_items');
            const data = await response.json();
            todoListUl.innerHTML = '';
            if (data.todo_items && data.todo_items.length > 0) {
                const sortedItems = data.todo_items.sort((a, b) => a.is_completed - b.is_completed || a.id - b.id);
                sortedItems.forEach(item => todoListUl.appendChild(renderTodoItem(item)));
            } else {
                const p = document.createElement('p');
                p.id = 'no-todo-items-message';
                p.className = 'text-gray-500 italic text-sm text-center py-4';
                p.textContent = 'Nenhuma tarefa por enquanto. Adicione uma!';
                todoListUl.appendChild(p);
            }
        } catch (error) {
            console.error('Erro ao buscar itens do di√°rio:', error);
        }
    }
    
    function renderTodoItem(item) {
        const listItem = document.createElement('li');
        listItem.className = `todo-item ${item.is_completed ? 'completed' : ''}`;
        listItem.dataset.itemId = item.id;
        const displayText = item.content.length > 40 ? item.content.substring(0, 40) + '...' : item.content;
        
        listItem.innerHTML = `<label class="todo-item-content"><input type="checkbox" class="todo-checkbox" ${item.is_completed ? 'checked' : ''}><span class="todo-item-text">${displayText}</span><span class="todo-item-text-tooltip">${item.content}</span></label><div class="todo-actions"><button type="button" class="todo-delete-btn" title="Excluir tarefa"><i class="fas fa-trash-alt"></i></button></div>`;
        
        listItem.querySelector('.todo-checkbox').addEventListener('change', handleToggleTodoItem);
        listItem.querySelector('.todo-delete-btn').addEventListener('click', handleDeleteTodoItem);
        return listItem;
    }

    addTodoBtn.addEventListener('click', async function() {
        const content = newTodoItemInput.value.trim();
        if (!content) return;
        if (todoListUl.children.length >= 5) {
            Toastify({ text: "Voc√™ atingiu o limite de 5 tarefas.", duration: 5000 }).showToast();
            return;
        }
        try {
            const response = await fetch('/student/api/todo_items', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ content }) });
            const data = await response.json();
            if (data.success) {
                document.getElementById('no-todo-items-message')?.remove();
                todoListUl.prepend(renderTodoItem(data.todo_item));
                newTodoItemInput.value = '';
                Toastify({ text: data.message, duration: 3000, style: { background: "linear-gradient(to right, #4caf50, #66bb6a)" } }).showToast();
            }
        } catch (error) { console.error('Erro ao adicionar tarefa:', error); }
    });

    async function handleToggleTodoItem(event) {
        const checkbox = event.currentTarget;
        const listItem = checkbox.closest('.todo-item');
        const itemId = listItem.dataset.itemId;
        try {
            const response = await fetch(`/student/api/todo_items/${itemId}/toggle`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ 'is_completed': checkbox.checked }) });
            const data = await response.json();
            if (data.success) {
                listItem.classList.toggle('completed', data.todo_item.is_completed);
                checkbox.checked = data.todo_item.is_completed;
                if (data.todo_item.is_completed) {
                    // Move to the end if completed
                    todoListUl.appendChild(listItem);
                } else {
                    // Re-sort if uncompleted to put it back at the top
                    await fetchAndRenderTodoItems(); 
                }
                Toastify({ text: data.message, duration: 3000, style: { background: "linear-gradient(to right, #4caf50, #66bb6a)" } }).showToast();
            } else { 
                checkbox.checked = !checkbox.checked; // Revert checkbox state
                Toastify({ text: "N√£o foi poss√≠vel atualizar a tarefa.", duration: 3000, style: { background: "linear-gradient(to right, #ff416c, #ff4b2b)" } }).showToast();
            }
        } catch (error) { 
            console.error('Erro ao alternar tarefa:', error);
            checkbox.checked = !checkbox.checked; // Revert checkbox state on error
            Toastify({ text: "Erro de comunica√ß√£o. Tente novamente.", duration: 3000, style: { background: "linear-gradient(to right, #ff416c, #ff4b2b)" } }).showToast();
        }
    }


    async function handleDeleteTodoItem(event) {
        if (!confirm('Tem certeza?')) return;
        const button = event.currentTarget;
        const listItem = button.closest('.todo-item');
        const itemId = listItem.dataset.itemId;
        try {
            const response = await fetch(`/student/api/todo_items/${itemId}`, { method: 'DELETE', headers: { 'X-CSRFToken': csrfToken } });
            const data = await response.json();
            if (data.success) {
                listItem.remove();
                if (todoListUl.children.length === 0 && !document.getElementById('no-todo-items-message')) {
                    const p = document.createElement('p');
                    p.id = 'no-todo-items-message';
                    p.className = 'text-gray-500 italic text-sm text-center py-4';
                    p.textContent = 'Nenhuma tarefa por enquanto. Adicione uma!';
                    todoListUl.appendChild(p);
                }
                Toastify({ text: data.message, duration: 3000, style: { background: "linear-gradient(to right, #4caf50, #66bb6a)" } }).showToast();
            }
        } catch (error) { console.error('Erro ao excluir tarefa:', error); }
    }
    
    function displayDailyMotivation() {
        const today = new Date();
        const daysOfWeek = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
        const months = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        motivationDateElement.textContent = `${daysOfWeek[today.getDay()]}, ${today.getDate()} de ${months[today.getMonth()]} de ${today.getFullYear()}`;
        const motivationalPhrases = ["N√£o desista. O come√ßo √© sempre o mais dif√≠cil.", "A persist√™ncia √© o caminho do √™xito.", "Sua perseveran√ßa √© a ponte entre seus sonhos e a realidade.", "A disciplina √© a ponte entre metas e realiza√ß√µes."];
        const dayIndex = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24)) % motivationalPhrases.length;
        motivationTextElement.textContent = motivationalPhrases[dayIndex];
    }
    
    // <<< IN√çCIO DA NOVA IMPLEMENTA√á√ÉO: L√≥gica para o gr√°fico de pizza de estudo por mat√©ria >>>
    let subjectStudyChart = null;

    function initializeSubjectStudyChart() {
        const ctx = document.getElementById('subjectStudyChart');
        const studyData = {{ study_data_for_chart | tojson }};
        const chartContainer = document.querySelector('.subject-stats-card .chart-container');
        const noDataMessage = document.querySelector('.subject-stats-card .no-data-message');

        if (!ctx) return; // Garante que o canvas existe

        if (studyData.length === 0) {
            // Se n√£o h√° dados, esconde o canvas e mostra a mensagem
            ctx.style.display = 'none';
            if (noDataMessage) noDataMessage.style.display = 'flex';
            return;
        } else {
            // Se h√° dados, mostra o canvas e esconde a mensagem
            ctx.style.display = 'block';
            if (noDataMessage) noDataMessage.style.display = 'none';
        }

        const labels = studyData.map(item => item.name);
        const data = studyData.map(item => item.duration_seconds);
        const totalDuration = data.reduce((sum, current) => sum + current, 0);

        const backgroundColors = [
            'rgba(255, 99, 132, 0.7)', // Red
            'rgba(54, 162, 235, 0.7)', // Blue
            'rgba(255, 206, 86, 0.7)', // Yellow
            'rgba(75, 192, 192, 0.7)', // Green
            'rgba(153, 102, 255, 0.7)',// Purple
            'rgba(255, 159, 64, 0.7)', // Orange
            'rgba(199, 199, 199, 0.7)',// Grey
            'rgba(83, 102, 255, 0.7)', // Indigo
            'rgba(201, 203, 207, 0.7)' // Light Grey
        ];
        const borderColors = [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)',
            'rgba(199, 199, 199, 1)',
            'rgba(83, 102, 255, 1)',
            'rgba(201, 203, 207, 1)'
        ];

        if (subjectStudyChart) {
            subjectStudyChart.destroy(); // Destr√≥i a inst√¢ncia anterior do gr√°fico se existir
        }

        subjectStudyChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right', // Posi√ß√£o da legenda √† direita
                        labels: {
                            color: '#4b5563', // Cor do texto da legenda
                            font: {
                                size: 12
                            },
                            // Ajuste para telas menores
                            boxWidth: 20, // Largura da caixa de cor da legenda
                            padding: 10 // Preenchimento entre os itens da legenda
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    const rawValue = context.parsed;
                                    const percentage = (rawValue / totalDuration * 100).toFixed(1); // Calcula o percentual

                                    const hours = Math.floor(rawValue / 3600);
                                    const minutes = Math.floor((rawValue % 3600) / 60);
                                    const seconds = rawValue % 60;
                                    
                                    let timeString = '';
                                    if (hours > 0) timeString += `${hours}h `;
                                    if (minutes > 0) timeString += `${minutes}m `;
                                    // Adiciona segundos apenas se n√£o houver horas ou minutos, ou se for zero
                                    if (seconds > 0 || (hours === 0 && minutes === 0 && seconds === 0)) {
                                        timeString += `${seconds}s`;
                                    }
                                    
                                    label += `${timeString.trim()} (${percentage}%)`; // Inclui tempo formatado e percentual
                                }
                                return label;
                            }
                        }
                    }
                },
                // Ajustes para responsividade do gr√°fico
                layout: {
                    padding: {
                        left: 0,
                        right: 0,
                        top: 0,
                        bottom: 0
                    }
                }
            }
        });

        // Ajuste da legenda para telas menores
        const legendContainer = chartContainer.querySelector('.chartjs-legend'); // Classe gerada pelo Chart.js
        if (legendContainer) {
            const mediaQuery = window.matchMedia('(max-width: 768px)');
            const handleMediaQueryChange = (e) => {
                if (e.matches) {
                    // Telas pequenas: posicionar legenda abaixo, centralizado
                    subjectStudyChart.options.plugins.legend.position = 'bottom';
                    subjectStudyChart.options.plugins.legend.align = 'center';
                    subjectStudyChart.options.plugins.legend.labels.boxWidth = 10;
                    subjectStudyChart.options.plugins.legend.labels.padding = 5;
                } else {
                    // Telas grandes: posicionar legenda √† direita
                    subjectStudyChart.options.plugins.legend.position = 'right';
                    subjectStudyChart.options.plugins.legend.align = 'center'; // Padr√£o
                    subjectStudyChart.options.plugins.legend.labels.boxWidth = 20;
                    subjectStudyChart.options.plugins.legend.labels.padding = 10;
                }
                subjectStudyChart.update();
            };
            mediaQuery.addEventListener('change', handleMediaQueryChange);
            handleMediaQueryChange(mediaQuery); // Chama na inicializa√ß√£o
        }
    }
    // <<< FIM DA NOVA IMPLEMENTA√á√ÉO >>>
    
    initializeDashboard();
});
</script>
{% endblock %}
